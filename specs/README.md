# Specifications

仕様書駆動開発のSource of Truth

## 概要

このディレクトリには、app.babl.tech ホームページの仕様書を格納します。
**すべてのレイヤーを含めた全体が一つのSource of Truth** です。

## 仕様書のレイヤー構造

仕様書は3つのレイヤーで構成される。上位レイヤーほど抽象的・ビジネス寄り、下位レイヤーほど具体的・技術寄りとなる。

```
┌─────────────────────────────────────────────┐
│  L1: ビジネス仕様（Business Spec）           │  ← 非技術者向け
│  「何を実現するか」「なぜ必要か」             │
├─────────────────────────────────────────────┤
│  L2: 機能仕様（Functional Spec）             │  ← 技術者・非技術者共通
│  「どう振る舞うか」「何が起きるか」           │
├─────────────────────────────────────────────┤
│  L3: 技術仕様（Technical Spec）              │  ← 技術者向け
│  「どう実装するか」「どんな制約があるか」     │
└─────────────────────────────────────────────┘
```

### L1: ビジネス仕様（Business Spec）

**対象読者**: 非技術者、ステークホルダー、経営層

**記載内容**:
- ビジネス目標・KPI
- ユーザーストーリー（〜として、〜したい、なぜなら〜）
- ユースケース概要
- 用語定義（ユビキタス言語）

**記載しないこと**:
- 技術用語（API、DB、トランザクション等）
- 実装詳細
- 技術的制約

**例**:
```markdown
## ユーザーストーリー

### お問い合わせ
- 訪問者として、問い合わせフォームから連絡したい
- なぜなら、サービスについて質問があるから

### 期待する結果
- 問い合わせ内容が担当者に届く
- 訪問者は送信完了を確認できる
```

---

### L2: 機能仕様（Functional Spec）

**対象読者**: 技術者、QA、デザイナー

**記載内容**:
- 画面・機能の振る舞い
- 入力項目と検証ルール
- 状態遷移
- エラーケースと対応
- 受け入れ条件（Acceptance Criteria）

**記載しないこと**:
- 具体的な技術選定（どのライブラリを使うか等）
- DB設計、API設計の詳細
- パフォーマンス要件の具体値

**例**:
```markdown
## お問い合わせフォーム

### 入力項目
| 項目 | 必須 | 検証ルール |
|------|------|-----------|
| 名前 | ○ | 1〜50文字 |
| メールアドレス | ○ | メール形式 |
| 内容 | ○ | 1〜1000文字 |

### 振る舞い
1. 送信ボタン押下時、検証を実行
2. 検証エラーがあれば、該当項目にエラー表示
3. 検証成功なら送信処理を実行
4. 送信成功なら完了メッセージを表示
5. 送信失敗ならエラーメッセージを表示

### エラーケース
- ネットワークエラー: 「送信に失敗しました。再度お試しください」
- サーバーエラー: 「システムエラーが発生しました」
```

---

### L3: 技術仕様（Technical Spec）

**対象読者**: 開発者、インフラエンジニア

**記載内容**:
- API設計（エンドポイント、リクエスト/レスポンス）
- データモデル・DB設計
- トランザクション要件（分離レベル等）
- 非機能要件（パフォーマンス、セキュリティ）
- 外部サービス連携
- 技術的制約・前提条件

**例**:
```markdown
## お問い合わせAPI

### エンドポイント
POST /api/contact

### リクエスト
```json
{
  "name": "string",
  "email": "string",
  "message": "string"
}
```

### レスポンス
- 200: 送信成功
- 400: バリデーションエラー
- 500: サーバーエラー

### 処理フロー
1. リクエストバリデーション（Zod）
2. メール送信（SendGrid API）
3. 送信ログをDBに保存

### トランザクション
- 分離レベル: READ COMMITTED
- メール送信失敗時もログは保存（部分的成功を許容）

### レート制限
- 同一IPから1分間に5回まで
```

---

## ディレクトリ構成

```
specs/
├── README.md                    # 本ファイル（仕様書の書き方）
├── glossary.md                  # 用語集（全体共通）
│
└── [feature-name]/              # 機能ごとのディレクトリ
    ├── L1-business.md           # ビジネス仕様
    ├── L2-functional.md         # 機能仕様
    └── L3-technical.md          # 技術仕様
```

## レイヤー間の関係

- **上位レイヤーは下位レイヤーの「なぜ」を説明する**
- **下位レイヤーは上位レイヤーの「どうやって」を説明する**
- 上位で決められないことは下位で決定する
- 下位の決定が上位と矛盾してはならない

```
L1: 「問い合わせ内容が担当者に届く」
      ↓ どうやって？
L2: 「送信ボタン押下で送信処理を実行」
      ↓ どうやって？
L3: 「POST /api/contact → SendGrid API → DB保存」
```

## 運用ルール

1. 新機能の開発前に、L1から順に仕様書を作成する
2. L1だけで技術判断できない場合、L2・L3で詳細化する
3. 仕様変更時は、影響するレイヤーすべてを更新する
4. 仕様書に基づいてテストを作成する
5. テストが通るように実装する
6. 実装と仕様の乖離が発生した場合は、仕様書を正とする

## どのレイヤーまで書くか

- **シンプルな機能**: L1 + L2 で十分な場合が多い
- **技術的判断が必要な機能**: L3 まで書く
- **外部連携・トランザクション・パフォーマンス要件がある機能**: L3 必須

判断基準: 「L2だけ読んで、開発者が迷わず実装できるか？」
→ 迷う可能性があるなら L3 を書く
